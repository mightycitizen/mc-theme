{#
/**
 * @file
 * Custom block created by HeaderBlock in mc_custom module.
 *
 */
#}
{% set menu_data = [] %}

{#
  Loop through menu items and add to new array, with a slightly different structure
  Formats icon for front end integration and moves it to the same level as other link data.
#}
{% for menu_name in ['main', 'main-utility', 'main-cta'] %}
  {# New array for current menu #}
  {% set current_menu = [] %}

  {% set items = drupal_menu(menu_name, expand=true) %}

  {% for key, item in items['#items'] %}
    {% set key = key|split(':')[1] %}

    {# Get icon field and add to array #}
    {% set menu_item_extras = drupal_entity('menu_link_content', key, check_access=false) %}

    {% set item = item|merge({
      text: item.title,
      url: item.url.toString(),
      icon: menu_item_extras['#menu_link_content'].field_icon.0 ? mc_icon(menu_item_extras['#menu_link_content'].field_icon.0.target_id) : NULL,
    })|without('title') %}

    {# Get children menu items â€“ repeat for multiple levels #}
    {% if item.below %}
      {% set children = [] %}
      {% for child in item.below %}
        {% set children = children|merge([child|merge({
          text: child.title,
          url: child.url.toString(),
        })|without('title')]) %}
      {% endfor %}
      {% set item = item|merge({children: children}) %}
    {% endif %}

    {% set current_menu = current_menu|merge([item]) %}
  {% endfor %}

  {% set menu_data = menu_data|merge({
    (menu_name): current_menu
  }) %}
{% endfor %}

{# Pass updated menu data to SDC. #}
{{ include('mc_theme:header', {
  menu: menu_data['main'],
  utility_menu: menu_data['main-utility'],
  cta_menu: menu_data['main-cta'],
}) }}
